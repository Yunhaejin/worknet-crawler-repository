import os
import sys
import time
import traceback
import hashlib
import json

import firebase_admin
from firebase_admin import firestore
import functions_framework
from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options

# ==============================================================================
# Â Global Setup
# ==============================================================================
try:
    if not firebase_admin._apps:
        firebase_admin.initialize_app()
    db = firestore.client()

    chrome_options = Options()
    chrome_options.add_argument("--headless")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_argument("--disable-gpu")
    chrome_options.add_argument("--window-size=1920x1080")
    chrome_options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36")

    # (ê¸°ì¡´ REGION_CODES ë”•ì…”ë„ˆë¦¬ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤)
    REGION_CODES = {
        "ì„œìš¸ ê°•ë‚¨êµ¬": "11680", "ì„œìš¸ ê°•ë™êµ¬": "11740", "ì„œìš¸ ê°•ë¶êµ¬": "11305", "ì„œìš¸ ê°•ì„œêµ¬": "11500", 
        "ì„œìš¸ ê´€ì•…êµ¬": "11620", "ì„œìš¸ ê´‘ì§„êµ¬": "11215", "ì„œìš¸ êµ¬ë¡œêµ¬": "11530", "ì„œìš¸ ê¸ˆì²œêµ¬": "11545",
        "ì„œìš¸ ë…¸ì›êµ¬": "11350", "ì„œìš¸ ë„ë´‰êµ¬": "11320", "ì„œìš¸ ë™ëŒ€ë¬¸êµ¬": "11230", "ì„œìš¸ ë™ì‘êµ¬": "11590",
        "ì„œìš¸ ë§ˆí¬êµ¬": "11440", "ì„œìš¸ ì„œëŒ€ë¬¸êµ¬": "11410", "ì„œìš¸ ì„œì´ˆêµ¬": "11650", "ì„œìš¸ ì„±ë™êµ¬": "11200",
        "ì„œìš¸ ì„±ë¶êµ¬": "11290", "ì„œìš¸ ì†¡íŒŒêµ¬": "11710", "ì„œìš¸ ì–‘ì²œêµ¬": "11470", "ì„œìš¸ ì˜ë“±í¬êµ¬": "11560",
        "ì„œìš¸ ìš©ì‚°êµ¬": "11170", "ì„œìš¸ ì€í‰êµ¬": "11380", "ì„œìš¸ ì¢…ë¡œêµ¬": "11110", "ì„œìš¸ ì¤‘êµ¬": "11140",
        "ì„œìš¸ ì¤‘ë‘êµ¬": "11260", "ë¶€ì‚° ê°•ì„œêµ¬": "26440", "ë¶€ì‚° ê¸ˆì •êµ¬": "26410", "ë¶€ì‚° ê¸°ì¥êµ°": "26710",
        "ë¶€ì‚° ë‚¨êµ¬": "26290", "ë¶€ì‚° ë™êµ¬": "26170", "ë¶€ì‚° ë™ë˜êµ¬": "26260", "ë¶€ì‚° ë¶€ì‚°ì§„êµ¬": "26230",
        "ë¶€ì‚° ë¶êµ¬": "26320", "ë¶€ì‚° ì‚¬ìƒêµ¬": "26530", "ë¶€ì‚° ì‚¬í•˜êµ¬": "26380", "ë¶€ì‚° ì„œêµ¬": "26140",
        "ë¶€ì‚° ìˆ˜ì˜êµ¬": "26500", "ë¶€ì‚° ì—°ì œêµ¬": "26470", "ë¶€ì‚° ì˜ë„êµ¬": "26200", "ë¶€ì‚° ì¤‘êµ¬": "26110",
        "ë¶€ì‚° í•´ìš´ëŒ€êµ¬": "26350", "ëŒ€êµ¬ êµ°ìœ„êµ°": "27720", "ëŒ€êµ¬ ë‚¨êµ¬": "27200", "ëŒ€êµ¬ ë‹¬ì„œêµ¬": "27290",
        "ëŒ€êµ¬ ë‹¬ì„±êµ°": "27710", "ëŒ€êµ¬ ë™êµ¬": "27140", "ëŒ€êµ¬ ë¶êµ¬": "27230", "ëŒ€êµ¬ ì„œêµ¬": "27170",
        "ëŒ€êµ¬ ìˆ˜ì„±êµ¬": "27260", "ëŒ€êµ¬ ì¤‘êµ¬": "27110", "ì¸ì²œ ê°•í™”êµ°": "28710", "ì¸ì²œ ê³„ì–‘êµ¬": "28245",
        "ì¸ì²œ ë‚¨ë™êµ¬": "28200", "ì¸ì²œ ë™êµ¬": "28140", "ì¸ì²œ ë¯¸ì¶”í™€êµ¬": "28177", "ì¸ì²œ ë¶€í‰êµ¬": "28237",
        "ì¸ì²œ ì„œêµ¬": "28260", "ì¸ì²œ ì—°ìˆ˜êµ¬": "28185", "ì¸ì²œ ì˜¹ì§„êµ°": "28720", "ì¸ì²œ ì¤‘êµ¬": "28110",
        "ê´‘ì£¼ ê´‘ì‚°êµ¬": "29200", "ê´‘ì£¼ ë‚¨êµ¬": "29155", "ê´‘ì£¼ ë™êµ¬": "29110", "ê´‘ì£¼ ë¶êµ¬": "29170",
        "ê´‘ì£¼ ì„œêµ¬": "29140", "ëŒ€ì „ ëŒ€ë•êµ¬": "30230", "ëŒ€ì „ ë™êµ¬": "30110", "ëŒ€ì „ ì„œêµ¬": "30170",
        "ëŒ€ì „ ìœ ì„±êµ¬": "30200", "ëŒ€ì „ ì¤‘êµ¬": "30140", "ì „ë¶ ê³ ì°½êµ°": "52790", "ì „ë¶ êµ°ì‚°ì‹œ": "52130",
        "ì „ë¶ ê¹€ì œì‹œ": "52210", "ì „ë¶ ë‚¨ì›ì‹œ": "52190", "ì „ë¶ ë¬´ì£¼êµ°": "52730", "ì „ë¶ ë¶€ì•ˆêµ°": "52800",
        "ì „ë¶ ìˆœì°½êµ°": "52770", "ì „ë¶ ì™„ì£¼êµ°": "52710", "ì „ë¶ ìµì‚°ì‹œ": "52140", "ì „ë¶ ì„ì‹¤êµ°": "52750",
        "ì „ë¶ ì¥ìˆ˜êµ°": "52740", "ì „ë¶ ì „ì£¼ì‹œ": "52110", "ì „ë¶ ì „ì£¼ì‹œ ë•ì§„êµ¬": "52113", "ì „ë¶ ì „ì£¼ì‹œ ì™„ì‚°êµ¬": "52111",
        "ì „ë¶ ì •ìì‹œ": "52180", "ì „ë¶ ì§„ì•ˆêµ°": "52720", "ìš¸ì‚° ë‚¨êµ¬": "31140", "ìš¸ì‚° ë™êµ¬": "31170",
        "ìš¸ì‚° ë¶êµ¬": "31200", "ìš¸ì‚° ìš¸ì£¼êµ°": "31710", "ìš¸ì‚° ì¤‘êµ¬": "31110", "ì„¸ì¢…": "36110",
        "ê²½ê¸° ê°€í‰êµ°": "41820", "ê²½ê¸° ê³ ì–‘ì‹œ": "41280", "ê²½ê¸° ê³ ì–‘ì‹œ ë•ì–‘êµ¬": "41281", "ê²½ê¸° ê³ ì–‘ì‹œ ì¼ì‚°ë™êµ¬": "41285",
        "ê²½ê¸° ê³ ì–‘ì‹œ ì¼ì‚°ì„œêµ¬": "41287", "ê²½ê¸° ê³¼ì²œì‹œ": "41290", "ê²½ê¸° ê´‘ëª…ì‹œ": "41210", "ê²½ê¸° ê´‘ì£¼ì‹œ": "41610",
        "ê²½ê¸° êµ¬ë¦¬ì‹œ": "41310", "ê²½ê¸° êµ°í¬ì‹œ": "41410", "ê²½ê¸° ê¹€í¬ì‹œ": "41570", "ê²½ê¸° ë‚¨ì–‘ì£¼ì‹œ": "41360",
        "ê²½ê¸° ë™ë‘ì²œì‹œ": "41250", "ê²½ê¸° ë¶€ì²œì‹œ": "41190", "ê²½ê¸° ì„±ë‚¨ì‹œ": "41130", "ê²½ê¸° ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬": "41135",
        "ê²½ê¸° ì„±ë‚¨ì‹œ ìˆ˜ì •êµ¬": "41131", "ê²½ê¸° ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬": "41133", "ê²½ê¸° ìˆ˜ì›ì‹œ": "41110", "ê²½ê¸° ìˆ˜ì›ì‹œ ê¶Œì„ êµ¬": "41113",
        "ê²½ê¸° ìˆ˜ì›ì‹œ ì˜í†µêµ¬": "41117", "ê²½ê¸° ìˆ˜ì›ì‹œ ì¥ì•ˆêµ¬": "41111", "ê²½ê¸° ìˆ˜ì›ì‹œ íŒ”ë‹¬êµ¬": "41115", "ê²½ê¸° ì‹œí¥ì‹œ": "41390",
        "ê²½ê¸° ì•ˆì‚°ì‹œ": "41270", "ê²½ê¸° ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬": "41273", "ê²½ê¸° ì•ˆì‚°ì‹œ ìƒë¡êµ¬": "41271", "ê²½ê¸° ì•ˆì„±ì‹œ": "41550",
        "ê²½ê¸° ì•ˆì–‘ì‹œ": "41170", "ê²½ê¸° ì•ˆì–‘ì‹œ ë™ì•ˆêµ¬": "41173", "ê²½ê¸° ì•ˆì–‘ì‹œ ë§Œì•ˆêµ¬": "41171", "ê²½ê¸° ì–‘ì£¼ì‹œ": "41630",
        "ê²½ê¸° ì–‘í‰êµ°": "41830", "ê²½ê¸° ì—¬ì£¼ì‹œ": "41670", "ê²½ê¸° ì—°ì²œêµ°": "41800", "ê²½ê¸° ì˜¤ì‚°ì‹œ": "41370",
        "ê²½ê¸° ìš©ì¸ì‹œ": "41460", "ê²½ê¸° ìš©ì¸ì‹œ ê¸°í¥êµ¬": "41463", "ê²½ê¸° ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬": "41465", "ê²½ê¸° ìš©ì¸ì‹œ ì²˜ì¸êµ¬": "41461",
        "ê²½ê¸° ì˜ì™•ì‹œ": "41430", "ê²½ê¸° ì˜ì •ë¶€ì‹œ": "41150", "ê²½ê¸° ì´ì²œì‹œ": "41500", "ê²½ê¸° íŒŒì£¼ì‹œ": "41480",
        "ê²½ê¸° í‰íƒì‹œ": "41220", "ê²½ê¸° í¬ì²œì‹œ": "41650", "ê²½ê¸° í•˜ë‚¨ì‹œ": "41450", "ê²½ê¸° í™”ì„±ì‹œ": "41590",
        "ì¶©ë¶ ê´´ì‚°êµ°": "43760", "ì¶©ë¶ ë‹¨ì–‘êµ°": "43800", "ì¶©ë¶ ë³´ì€êµ°": "43720", "ì¶©ë¶ ì˜ë™êµ°": "43740",
        "ì¶©ë¶ ì˜¥ì²œêµ°": "43730", "ì¶©ë¶ ìŒì„±êµ°": "43770", "ì¶©ë¶ ì œì²œì‹œ": "43150", "ì¶©ë¶ ì¦í‰êµ°": "43745",
        "ì¶©ë¶ ì§„ì²œêµ°": "43750", "ì¶©ë¶ ì²­ì£¼ì‹œ": "43110", "ì¶©ë¶ ì²­ì£¼ì‹œ ìƒë‹¹êµ¬": "43111", "ì¶©ë¶ ì²­ì£¼ì‹œ ì„œì›êµ¬": "43112",
        "ì¶©ë¶ ì²­ì£¼ì‹œ ì²­ì›êµ¬": "43114", "ì¶©ë¶ ì²­ì£¼ì‹œ í¥ë•êµ¬": "43113", "ì¶©ë¶ ì¶©ì£¼ì‹œ": "43130", "ì¶©ë‚¨ ê³„ë£¡ì‹œ": "44250",
        "ì¶©ë‚¨ ê³µì£¼ì‹œ": "44150", "ì¶©ë‚¨ ê¸ˆì‚°êµ°": "44710", "ì¶©ë‚¨ ë…¼ì‚°ì‹œ": "44230", "ì¶©ë‚¨ ë‹¹ì§„ì‹œ": "44270",
        "ì¶©ë‚¨ ë³´ë ¹ì‹œ": "44180", "ì¶©ë‚¨ ë¶€ì—¬êµ°": "44760", "ì¶©ë‚¨ ì„œì‚°ì‹œ": "44210", "ì¶©ë‚¨ ì„œì²œêµ°": "44770",
        "ì¶©ë‚¨ ì•„ì‚°ì‹œ": "44200", "ì¶©ë‚¨ ì˜ˆì‚°êµ°": "44810", "ì¶©ë‚¨ ì²œì•ˆì‹œ": "44130", "ì¶©ë‚¨ ì²œì•ˆì‹œ ë™ë‚¨êµ¬": "44131",
        "ì¶©ë‚¨ ì²œì•ˆì‹œ ì„œë¶êµ¬": "44133", "ì¶©ë‚¨ ì²­ì–‘êµ°": "44790", "ì¶©ë‚¨ íƒœì•ˆêµ°": "44825", "ì¶©ë‚¨ í™ì„±êµ°": "44800",
        "ì „ë‚¨ ê°•ì§„êµ°": "46810", "ì „ë‚¨ ê³ í¥êµ°": "46770", "ì „ë‚¨ ê³¡ì„±êµ°": "46720", "ì „ë‚¨ ê´‘ì–‘ì‹œ": "46230",
        "ì „ë‚¨ êµ¬ë¡€êµ°": "46730", "ì „ë‚¨ ë‚˜ì£¼ì‹œ": "46170", "ì „ë‚¨ ë‹´ì–‘êµ°": "46710", "ì „ë‚¨ ëª©í¬ì‹œ": "46110",
        "ì „ë‚¨ ë¬´ì•ˆêµ°": "46840", "ì „ë‚¨ ë³´ì„±êµ°": "46780", "ì „ë‚¨ ìˆœì²œì‹œ": "46150", "ì „ë‚¨ ì‹ ì•ˆêµ°": "46910",
        "ì „ë‚¨ ì—¬ìˆ˜ì‹œ": "46130", "ì „ë‚¨ ì˜ê´‘êµ°": "46870", "ì „ë‚¨ ì˜ì•”êµ°": "46830", "ì „ë‚¨ ì™„ë„êµ°": "46890",
        "ì „ë‚¨ ì¥ì„±êµ°": "46880", "ì „ë‚¨ ì¥í¥êµ°": "46800", "ì „ë‚¨ ì§„ë„êµ°": "46900", "ì „ë‚¨ í•¨í‰êµ°": "46860",
        "ì „ë‚¨ í•´ë‚¨êµ°": "46820", "ì „ë‚¨ í™”ìˆœêµ°": "46790", "ê²½ë¶ ê²½ì‚°ì‹œ": "47290", "ê²½ë¶ ê²½ì£¼ì‹œ": "47130",
        "ê²½ë¶ ê³ ë ¹êµ°": "47830", "ê²½ë¶ êµ¬ë¯¸ì‹œ": "47190", "ê²½ë¶ ê¹€ì²œì‹œ": "47150", "ê²½ë¶ ë¬¸ê²½ì‹œ": "47280",
        "ê²½ë¶ ë´‰í™”êµ°": "47920", "ê²½ë¶ ìƒì£¼ì‹œ": "47250", "ê²½ë¶ ì„±ì£¼êµ°": "47840", "ê²½ë¶ ì•ˆë™ì‹œ": "47170",
        "ê²½ë¶ ì˜ë•êµ°": "47770", "ê²½ë¶ ì˜ì–‘êµ°": "47760", "ê²½ë¶ ì˜ì£¼ì‹œ": "47210", "ê²½ë¶ ì˜ì²œì‹œ": "47230",
        "ê²½ë¶ ì˜ˆì²œêµ°": "47900", "ê²½ë¶ ìš¸ë¦‰êµ°": "47940", "ê²½ë¶ ìš¸ì§„êµ°": "47930", "ê²½ë¶ ì˜ì„±êµ°": "47730",
        "ê²½ë¶ ì²­ë„êµ°": "47820", "ê²½ë¶ ì²­ì†¡êµ°": "47750", "ê²½ë¶ ì¹ ê³¡êµ°": "47850", "ê²½ë¶ í¬í•­ì‹œ": "47110",
        "ê²½ë¶ í¬í•­ì‹œ ë‚¨êµ¬": "47111", "ê²½ë¶ í¬í•­ì‹œ ë¶êµ¬": "47113", "ê²½ë‚¨ ê±°ì œì‹œ": "48310", "ê²½ë‚¨ ê±°ì°½êµ°": "48880",
        "ê²½ë‚¨ ê³ ì„±êµ°": "48820", "ê²½ë‚¨ ê¹€í•´ì‹œ": "48250", "ê²½ë‚¨ ë‚¨í•´êµ°": "48840", "ê²½ë‚¨ ë°€ì–‘ì‹œ": "48270",
        "ê²½ë‚¨ ì‚¬ì²œì‹œ": "48240", "ê²½ë‚¨ ì‚°ì²­êµ°": "48860", "ê²½ë‚¨ ì–‘ì‚°ì‹œ": "48330", "ê²½ë‚¨ ì˜ë ¹êµ°": "48720",
        "ê²½ë‚¨ ì§„ì£¼ì‹œ": "48170", "ê²½ë‚¨ ì°½ë…•êµ°": "48740", "ê²½ë‚¨ ì°½ì›ì‹œ": "48120", "ê²½ë‚¨ ì°½ì›ì‹œ ë§ˆì‚°í•©í¬êµ¬": "48125",
        "ê²½ë‚¨ ì°½ì›ì‹œ ë§ˆì‚°íšŒì›êµ¬": "48127", "ê²½ë‚¨ ì°½ì›ì‹œ ì„±ì‚°êµ¬": "48123", "ê²½ë‚¨ ì°½ì›ì‹œ ì˜ì°½êµ¬": "48121",
        "ê²½ë‚¨ ì°½ì›ì‹œ ì§„í•´êµ¬": "48129", "ê²½ë‚¨ í†µì˜ì‹œ": "48220", "ê²½ë‚¨ í•˜ë™êµ°": "48850", "ê²½ë‚¨ í•¨ì•ˆêµ°": "48730",
        "ê²½ë‚¨ í•¨ì–‘êµ°": "48870", "ê²½ë‚¨ í•©ì²œêµ°": "48890", "ì œì£¼ ì„œê·€í¬ì‹œ": "50130", "ì œì£¼ ì œì£¼ì‹œ": "50110",
        "ê°•ì› ê°•ë¦‰ì‹œ": "51150", "ê°•ì› ê³ ì„±êµ°": "51820", "ê°•ì› ë™í•´ì‹œ": "51170", "ê°•ì› ì‚¼ì²™ì‹œ": "51230",
        "ê°•ì› ì†ì´ˆì‹œ": "51210", "ê°•ì› ì–‘êµ¬êµ°": "51800", "ê°•ì› ì–‘ì–‘êµ°": "51830", "ê°•ì› ì˜ì›”êµ°": "51750",
        "ê°•ì› ì›ì£¼ì‹œ": "51130", "ê°•ì› ì¸ì œêµ°": "51810", "ê°•ì› ì •ì„ êµ°": "51770", "ê°•ì› ì² ì›êµ°": "51780",
        "ê°•ì› ì¶˜ì²œì‹œ": "51110", "ê°•ì› íƒœë°±ì‹œ": "51190", "ê°•ì› í‰ì°½êµ°": "51760", "ê°•ì› í™ì²œêµ°": "51720",
        "ê°•ì› í™”ì²œêµ°": "51790", "ê°•ì› íš¡ì„±êµ°": "51730"
    }
except Exception as e:
    print(f"ğŸš¨ CRITICAL ERROR DURING INITIALIZATION: {e}")
    traceback.print_exc(file=sys.stdout)

# main.py íŒŒì¼ì—ì„œ ì´ í•¨ìˆ˜ë¥¼ ì°¾ì•„ì„œ ì „ì²´ë¥¼ êµì²´í•˜ì„¸ìš”.

def get_jobs_by_selenium(search_region):
    print(f"--- '{search_region}' ì§€ì—­ ê²€ìƒ‰ ì‹œì‘ ---")
    region_code = REGION_CODES.get(search_region)
    if not region_code:
        print(f"ğŸš¨ '{search_region}'ì— í•´ë‹¹í•˜ëŠ” ì§€ì—­ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.")
        return []

    job_results = []
    try:
        # Dockerfileì„ í†µí•´ ì‹œìŠ¤í…œì— ì„¤ì¹˜ëœ chromedriverì˜ ê²½ë¡œë¥¼ ì§ì ‘ ì§€ì •í•©ë‹ˆë‹¤.
        service = Service(executable_path='/usr/bin/chromedriver')
        
        # serviceì™€ optionsë¥¼ ë‹¤ì‹œ í•¨ê»˜ ì‚¬ìš©í•©ë‹ˆë‹¤.
        with webdriver.Chrome(service=service, options=chrome_options) as driver:
            base_url = "https://www.work.go.kr/empInfo/empInfoSrch/list/dtlEmpSrchList.do"
            search_params = f"region={region_code}&resultCnt=100&sortOrderBy=DESC&sortField=DATE"
            target_url = f"{base_url}?{search_params}"
            driver.get(target_url)

            time.sleep(3) # í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°

            soup = BeautifulSoup(driver.page_source, 'html.parser')
            job_list_rows = soup.select("table.board-list > tbody > tr")

            if not job_list_rows or "ì—†ìŠµë‹ˆë‹¤" in job_list_rows[0].text:
                print(f"âœ… '{search_region}' ì§€ì—­ì— ì±„ìš©ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
                return []

            for row in job_list_rows:
                company_tag = row.select_one("td:nth-child(2) a.cp_name")
                title_tag = row.select_one("td:nth-child(3) .cp-info-in > a")
                if company_tag and title_tag:
                    job_results.append({
                        'company': company_tag.text.strip(),
                        'title': title_tag.text.strip(),
                        'source_region': search_region
                    })
            print(f"âœ… '{search_region}' ì§€ì—­ì—ì„œ {len(job_results)}ê°œì˜ ì±„ìš© ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"ğŸš¨ '{search_region}' í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        traceback.print_exc(file=sys.stdout)
    return job_results

def upload_jobs_to_firestore(jobs_list):
    if not db or not jobs_list:
        print("ğŸš¨ Firestore í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ê±°ë‚˜ ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return
    try:
        batch = db.batch()
        for job in jobs_list:
            # Firestoreì— ì €ì¥ë  ë•Œ ì„œë²„ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡
            job['crawled_at'] = firestore.SERVER_TIMESTAMP
            # [íšŒì‚¬ëª…]_[ì±„ìš©ì œëª©]_[ì§€ì—­]ì„ ì¡°í•©í•˜ì—¬ ê³ ìœ  ID ìƒì„±
            unique_key = f"{job['company']}_{job['title']}_{job['source_region']}"
            doc_id = hashlib.sha256(unique_key.encode()).hexdigest()
            doc_ref = db.collection('worknet_jobs').document(doc_id)
            # merge=True ì˜µì…˜ìœ¼ë¡œ ì¤‘ë³µëœ ë°ì´í„°ëŠ” ë®ì–´ì“°ê¸° (ì—…ë°ì´íŠ¸)
            batch.set(doc_ref, job, merge=True)
        batch.commit()
        print(f"âœ… ì´ {len(jobs_list)}ê°œ ì •ë³´ Firestore ì—…ë¡œë“œ ì™„ë£Œ.")
    except Exception as e:
        print(f"ğŸš¨ Firestore ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        traceback.print_exc(file=sys.stdout)

# ==============================================================================
# Â â­ NEW: Batch Crawling Logic
# ==============================================================================
def crawl_all_and_upload():
    """
    REGION_CODESì— ì •ì˜ëœ ëª¨ë“  ì§€ì—­ì„ í¬ë¡¤ë§í•˜ê³  ê²°ê³¼ë¥¼ Firestoreì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.
    """
    all_jobs_list = []
    total_regions = len(REGION_CODES)
    processed_count = 0

    print(f"ğŸš€ ì´ {total_regions}ê°œ ì§€ì—­ ì „ì²´ì— ëŒ€í•œ ì±„ìš© ì •ë³´ ìˆ˜ì§‘ì„ ì‹œì‘í•©ë‹ˆë‹¤.")

    for region_name in REGION_CODES.keys():
        processed_count += 1
        # ì›Œí¬ë„· ì„œë²„ì— ë¶€ë‹´ì„ ì£¼ì§€ ì•Šë„ë¡ ê° ìš”ì²­ ì‚¬ì´ì— ì•½ê°„ì˜ ì§€ì—° ì‹œê°„ ì¶”ê°€
        time.sleep(2)
        
        jobs_from_region = get_jobs_by_selenium(region_name)
        if jobs_from_region:
            all_jobs_list.extend(jobs_from_region)
        
        print(f" tiáº¿n Ä‘á»™ ({processed_count}/{total_regions})")

    if all_jobs_list:
        print(f"\n\nâœ¨ ì´ {len(all_jobs_list)}ê°œì˜ ì±„ìš© ì •ë³´ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤. Firestore ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.")
        upload_jobs_to_firestore(all_jobs_list)
    else:
        print("\n\nğŸš¨ ëª¨ë“  ì§€ì—­ì—ì„œ ìˆ˜ì§‘ëœ ì±„ìš© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")

    print("ğŸ‰ ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")


# ==============================================================================
# Â â­ NEW: Cloud Function Entry Point
# ==============================================================================
@functions_framework.http
def batch_crawl_trigger(request):
    """
    HTTP ìš”ì²­ì„ í†µí•´ ì „ì²´ í¬ë¡¤ë§ ë° ì—…ë¡œë“œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•˜ëŠ” Cloud Functionì…ë‹ˆë‹¤.
    Cloud Schedulerì™€ ì—°ë™í•˜ì—¬ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    """
    try:
        # ì‹¤ì œ í¬ë¡¤ë§ ë¡œì§ì„ ë‹´ê³  ìˆëŠ” ë©”ì¸ í•¨ìˆ˜ í˜¸ì¶œ
        crawl_all_and_upload()
        # ì„±ê³µ ì‹œ ì‘ë‹µ
        return ("Batch crawling process completed successfully.", 200)
    except Exception as e:
        # ì‹¤íŒ¨ ì‹œ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  ì—ëŸ¬ ì‘ë‹µ
        error_message = f"ğŸš¨ An error occurred in batch_crawl_trigger: {e}"
        print(error_message)
        traceback.print_exc(file=sys.stdout)
        return (error_message, 500)
